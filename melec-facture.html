<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MELEC - Devis et Facturation</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root{--pri:#1a56db;--pl:#3b82f6;--pd:#1e40af;--acc:#f59e0b;--suc:#10b981;--dan:#ef4444;--g50:#f9fafb;--g100:#f3f4f6;--g200:#e5e7eb;--g300:#d1d5db;--g400:#9ca3af;--g500:#6b7280;--g600:#4b5563;--g700:#374151;--g800:#1f2937;--r:10px;--sh:0 1px 3px rgba(0,0,0,.1);--shm:0 4px 6px rgba(0,0,0,.07);--shl:0 10px 15px rgba(0,0,0,.1)}
*{box-sizing:border-box;margin:0;padding:0}body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--g100);color:var(--g800);line-height:1.6}
.hdr{background:linear-gradient(135deg,var(--pd),var(--pri));color:#fff;padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shm);position:sticky;top:0;z-index:100}
.hdr-l{display:flex;align-items:center;gap:1rem}.hdr h1{font-size:1.3rem;font-weight:700}.hdr-sub{font-size:.8rem;opacity:.85}
.tabs{display:flex;background:#fff;border-bottom:2px solid var(--g200);padding:0 1rem;overflow-x:auto}
.tab{padding:.9rem 1.5rem;cursor:pointer;font-weight:600;font-size:.9rem;color:var(--g500);border-bottom:3px solid transparent;transition:.2s;display:flex;align-items:center;gap:.5rem;white-space:nowrap;user-select:none}
.tab:hover{color:var(--pri);background:var(--g50)}.tab.active{color:var(--pri);border-bottom-color:var(--pri)}
.tab .badge{background:var(--pri);color:#fff;font-size:.7rem;padding:.1rem .5rem;border-radius:10px;font-weight:700}
.main{max-width:1400px;margin:0 auto;padding:1.5rem}.pnl{display:none}.pnl.active{display:block}
.card{background:#fff;border-radius:var(--r);box-shadow:var(--sh);padding:1.5rem;margin-bottom:1.5rem}
.ct{font-size:1.1rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}.ct i{color:var(--pri)}
.btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1.2rem;border-radius:8px;font-weight:600;font-size:.85rem;border:none;cursor:pointer;transition:.2s}
.btn-pri{background:var(--pri);color:#fff}.btn-pri:hover{background:var(--pd)}
.btn-suc{background:var(--suc);color:#fff}.btn-suc:hover{background:#059669}
.btn-dan{background:var(--dan);color:#fff}.btn-dan:hover{background:#dc2626}
.btn-acc{background:var(--acc);color:#fff}.btn-acc:hover{background:#d97706}
.btn-out{background:#fff;color:var(--pri);border:2px solid var(--pri)}.btn-out:hover{background:var(--pri);color:#fff}
.btn-sm{padding:.4rem .8rem;font-size:.8rem}.btn-lg{padding:.8rem 2rem;font-size:1rem}
.fg{margin-bottom:1rem}.fg label{display:block;font-weight:600;font-size:.85rem;margin-bottom:.3rem;color:var(--g700)}
.fc{width:100%;padding:.6rem .8rem;border:2px solid var(--g200);border-radius:8px;font-size:.9rem;transition:.2s;font-family:inherit}
.fc:focus{outline:none;border-color:var(--pl);box-shadow:0 0 0 3px rgba(59,130,246,.1)}select.fc{cursor:pointer}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
.dz{border:2px dashed var(--g300);border-radius:var(--r);padding:2.5rem;text-align:center;cursor:pointer;transition:.3s;background:var(--g50)}
.dz:hover,.dz.over{border-color:var(--pri);background:#eff6ff}
.dz i.fa-file-csv{font-size:2.5rem;color:var(--pl);margin-bottom:.8rem}.dz p{color:var(--g500);font-size:.9rem}.dz .mt{font-weight:600;color:var(--g700);font-size:1rem;margin-bottom:.3rem}
.tc{overflow-x:auto}table{width:100%;border-collapse:collapse;font-size:.85rem}
th{background:var(--g50);padding:.7rem .8rem;text-align:left;font-weight:700;color:var(--g600);border-bottom:2px solid var(--g200);font-size:.8rem;text-transform:uppercase}
td{padding:.6rem .8rem;border-bottom:1px solid var(--g100);vertical-align:middle}tr:hover td{background:var(--g50)}
.qi{width:65px;padding:.3rem;border:2px solid var(--g200);border-radius:6px;text-align:center;font-weight:600;font-family:inherit}.qi:focus{border-color:var(--pl);outline:none}
.price{font-weight:700;color:var(--pd)}.rb{background:var(--g100);padding:.15rem .5rem;border-radius:4px;font-family:monospace;font-size:.8rem;color:var(--g600)}
.sb{background:linear-gradient(135deg,#1e3a5f,#1a56db);color:#fff;border-radius:var(--r);padding:1.5rem}
.sr{display:flex;justify-content:space-between;padding:.4rem 0;font-size:.95rem}.sr .lbl{opacity:.9}
.dp{background:#fff;border:1px solid var(--g200);border-radius:var(--r);padding:2.5rem;max-width:850px;margin:0 auto;box-shadow:var(--shl)}
.dh{display:flex;justify-content:space-between;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:3px solid var(--pri)}
.dco{display:flex;align-items:center;gap:1rem}.dco .logo-svg{width:60px;height:60px;flex-shrink:0}
.dco .info h2{color:var(--pri);font-size:1.2rem}.dco .info p{font-size:.82rem;color:var(--g500);margin:0}
.dty{text-align:right}.dty h3{font-size:1.5rem;color:var(--pd);text-transform:uppercase;letter-spacing:.05em}
.dty .dn{font-size:.9rem;color:var(--g500)}.dty .dd{font-size:.85rem;color:var(--g400)}
.dcb{background:var(--g50);border-radius:8px;padding:1rem;margin-bottom:1.5rem}.dcb h4{font-size:.8rem;text-transform:uppercase;color:var(--g500);margin-bottom:.3rem}
.dtb{width:100%;border-collapse:collapse;margin-bottom:1.5rem}
.dtb th{background:var(--pri);color:#fff;padding:.6rem .8rem;font-size:.8rem;text-transform:uppercase;text-align:left}
.dtb td{padding:.5rem .8rem;border-bottom:1px solid var(--g200);font-size:.85rem}.dtb tr:nth-child(even){background:var(--g50)}
.tots{margin-left:auto;width:280px}.tots .rw{display:flex;justify-content:space-between;padding:.4rem 0;font-size:.9rem}
.tots .rw.grand{border-top:2px solid var(--g800);font-weight:800;font-size:1.1rem;padding-top:.6rem;margin-top:.3rem}
.df{margin-top:2rem;padding-top:1rem;border-top:1px solid var(--g200);font-size:.8rem;color:var(--g400);text-align:center}
.es{text-align:center;padding:3rem;color:var(--g400)}.es i{font-size:3rem;margin-bottom:1rem;display:block}.es p{font-size:1rem}
.alert{padding:.8rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.9rem;display:flex;align-items:center;gap:.5rem}
.al-i{background:#dbeafe;color:#1e40af}.al-s{background:#d1fae5;color:#065f46}.al-w{background:#fef3c7;color:#92400e}
.ab{display:flex;gap:.8rem;flex-wrap:wrap;margin-bottom:1.5rem}
.mov{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;justify-content:center;align-items:center}
.mov.active{display:flex}.mod{background:#fff;border-radius:var(--r);padding:2rem;width:90%;max-width:550px;box-shadow:var(--shl)}
.mod h3{margin-bottom:1rem}.moa{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.5rem}
.sbar{position:relative}.sbar input{width:100%;padding:.7rem .8rem .7rem 2.5rem;border:2px solid var(--g200);border-radius:8px;font-size:.9rem;font-family:inherit}
.sbar input:focus{border-color:var(--pl);outline:none}.sbar>i{position:absolute;left:.8rem;top:50%;transform:translateY(-50%);color:var(--g400)}
.hs{background:#fffbeb;border:1px solid #fde68a;border-radius:var(--r);padding:1.2rem;margin-bottom:1.5rem}
.hs h4{color:#92400e;margin-bottom:.5rem;display:flex;align-items:center;gap:.4rem}
.hs ol{padding-left:1.3rem;font-size:.9rem;color:#78350f}.hs li{margin-bottom:.3rem}
.tag{display:inline-block;padding:.15rem .5rem;border-radius:4px;font-size:.75rem;font-weight:600}
.tag-rs{background:#fee2e2;color:#dc2626}.tag-m{background:#dbeafe;color:#1d4ed8}
.ent-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}.ent-card{border:2px solid var(--g200);border-radius:var(--r);padding:1rem;cursor:pointer;transition:.2s;text-align:center}
.ent-card:hover{border-color:var(--pl);background:#eff6ff}.ent-card.sel{border-color:var(--pri);background:#dbeafe;box-shadow:0 0 0 3px rgba(26,86,219,.2)}
.ent-card .logo-svg{width:70px;height:70px;margin:0 auto .5rem}
.ent-card h3{font-size:.95rem;color:var(--g800)}.ent-card p{font-size:.75rem;color:var(--g500)}
@media print{
  @page{size:A4;margin:15mm}
  body{background:#fff!important;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important}
  .hdr,.tabs,.ab,.btn,.np,.mov,.hs,.pnl:not(#panel-document){display:none!important}
  .main{padding:0!important;max-width:100%!important}
  #panel-document{display:block!important}
  .dp{box-shadow:none!important;border:none!important;padding:0!important;max-width:100%!important}
  .dh{display:flex!important;border-bottom:3px solid #1a56db!important}
  .dco .logo-svg{width:50px!important;height:50px!important}
  .dco .info h2{color:#1a56db!important}
  .dty h3{color:#1e40af!important}
  .dtb th{background:#1a56db!important;color:#fff!important;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
  .dtb tr:nth-child(even){background:#f9fafb!important}
  .dcb{background:#f9fafb!important;border:1px solid #e5e7eb!important}
  .tots .rw.grand{border-top:2px solid #1f2937!important}
  .df{border-top:1px solid #e5e7eb!important}
  table{page-break-inside:auto}tr{page-break-inside:avoid}
}
@media(max-width:768px){.hdr{padding:.8rem 1rem}.hdr h1{font-size:1rem}.main{padding:1rem}.fr,.fr3{grid-template-columns:1fr}.tab{padding:.7rem 1rem;font-size:.8rem}.dh{flex-direction:column;gap:1rem}.dty{text-align:left}.tots{width:100%}.ent-grid{grid-template-columns:repeat(2,1fr)}}

</style>
</head>
<body>
<div class="hdr">
<div class="hdr-l">
<svg width="44" height="44" viewBox="0 0 44 44"><rect width="44" height="44" rx="10" fill="#fff"/><path d="M24 6L12 24h8l-4 14 16-20h-8z" fill="#1a56db"/></svg>
<div><h1>MELEC - Devis &amp; Facturation</h1><div class="hdr-sub">Gestion de mat&#233;riel &#233;lectrique &#8226; Import RS Components</div></div>
</div>
<div><button class="btn btn-acc" onclick="resetAll()"><i class="fas fa-redo"></i> Nouveau</button></div>
</div>

<div class="tabs">
<div class="tab active" data-tab="params" onclick="switchTab('params')"><i class="fas fa-cog"></i> Param&#232;tres</div>
<div class="tab" data-tab="import" onclick="switchTab('import')"><i class="fas fa-file-import"></i> Import CSV</div>
<div class="tab" data-tab="materiel" onclick="switchTab('materiel')"><i class="fas fa-list"></i> Mat&#233;riel <span class="badge" id="bc">0</span></div>
<div class="tab" data-tab="document" onclick="switchTab('document')"><i class="fas fa-file-invoice"></i> Document</div>
</div>

<div class="main">

<!-- ========== IMPORT ========== -->
<div class="pnl" id="panel-import">
<div class="hs">
<h4><i class="fas fa-info-circle"></i> Comment exporter depuis RS Components ?</h4>
<ol>
<li>Allez sur <strong>fr.rs-online.com</strong> et ajoutez vos articles au panier</li>
<li>Ouvrez votre panier et cliquez sur <strong>&#171; Exporter la liste &#187;</strong></li>
<li>Enregistrez le fichier CSV sur votre ordinateur</li>
<li>Glissez-d&#233;posez le fichier ci-dessous ou cliquez pour le s&#233;lectionner</li>
</ol>
</div>
<div class="card">
<div class="ct"><i class="fas fa-cloud-upload-alt"></i> Importer un fichier CSV RS Components</div>
<div class="dz" id="dropz" onclick="document.getElementById('csvF').click()">
<i class="fas fa-file-csv"></i>
<p class="mt">Glissez-d&#233;posez votre fichier CSV ici</p>
<p>ou cliquez pour s&#233;lectionner un fichier</p>
<input type="file" id="csvF" accept=".csv,.txt" hidden onchange="handleFile(event)">
</div>
<div id="impRes" style="margin-top:1rem"></div>
</div>
<div class="card">
<div class="ct"><i class="fas fa-plus-circle"></i> Ajouter manuellement un article</div>
<div class="fr">
<div class="fg"><label>R&#233;f&#233;rence RS</label><input type="text" class="fc" id="aRef" placeholder="Ex: 123-4567"></div>
<div class="fg"><label>D&#233;signation</label><input type="text" class="fc" id="aName" placeholder="Ex: Disjoncteur 16A"></div>
</div>
<div class="fr">
<div class="fg"><label>Prix unitaire HT (&#8364;)</label><input type="number" class="fc" id="aPrice" placeholder="0.00" step="0.01" min="0"></div>
<div class="fg"><label>Quantit&#233;</label><input type="number" class="fc" id="aQty" placeholder="1" min="1" value="1"></div>
</div>
<button class="btn btn-pri" onclick="addManual()"><i class="fas fa-plus"></i> Ajouter &#224; la liste</button>
</div>
</div>

<!-- ========== MATERIEL ========== -->
<div class="pnl" id="panel-materiel">
<div class="ab">
<div class="sbar" style="flex:1;min-width:200px"><i class="fas fa-search"></i><input type="text" placeholder="Rechercher dans la liste..." oninput="filterM(this.value)"></div>
<button class="btn btn-dan btn-sm" onclick="clearAll()"><i class="fas fa-trash"></i> Tout supprimer</button>
</div>
<div class="card">
<div class="tc">
<table><thead><tr>
<th>R&#233;f. RS</th><th>D&#233;signation</th><th>Fabricant</th><th>Source</th>
<th style="text-align:center">Qt&#233;</th><th style="text-align:right">P.U. HT</th>
<th style="text-align:right">Total HT</th><th style="text-align:center">Actions</th>
</tr></thead><tbody id="tBody"></tbody></table>
</div>
<div id="emSt" class="es"><i class="fas fa-box-open"></i><p>Aucun mat&#233;riel dans la liste</p><p style="font-size:.85rem">Importez un CSV ou ajoutez manuellement</p></div>
</div>
<div class="sb" id="sumBox" style="display:none">
<div class="sr"><span class="lbl">Nombre d'articles</span><span id="sArt">0</span></div>
<div class="sr"><span class="lbl">Total Mat&#233;riel HT</span><span id="sMat">0,00 &#8364;</span></div>
</div>
</div>

<!-- ========== PARAMETRES ========== -->
<div class="pnl active" id="panel-params">
<div class="card">
<div class="ct"><i class="fas fa-building"></i> Choisir une entreprise</div>
<p style="font-size:.9rem;color:#6b7280;margin-bottom:1rem">S&#233;lectionnez une entreprise fictive pour votre document :</p>
<div class="ent-grid" id="entGrid"></div>
</div>
<div class="card">
<div class="ct"><i class="fas fa-building"></i> Informations Entreprise</div>
<div class="fr">
<div class="fg"><label>Nom de l'entreprise</label><input type="text" class="fc" id="pCo" value="&#201;lectricit&#233; MELEC"></div>
<div class="fg"><label>SIRET</label><input type="text" class="fc" id="pSi" placeholder="123 456 789 00012"></div>
</div>
<div class="fg"><label>Adresse</label><input type="text" class="fc" id="pAd" value="Lyc&#233;e Samuel de Champlain"></div>
<div class="fr">
<div class="fg"><label>T&#233;l&#233;phone</label><input type="text" class="fc" id="pPh" placeholder="01 23 45 67 89"></div>
<div class="fg"><label>Email</label><input type="email" class="fc" id="pEm" placeholder="contact@entreprise.fr"></div>
</div>
</div>
<div class="card">
<div class="ct"><i class="fas fa-user"></i> Informations Client</div>
<div class="fr">
<div class="fg"><label>Nom du client</label><input type="text" class="fc" id="cNm" placeholder="Nom du client"></div>
<div class="fg"><label>Soci&#233;t&#233; (optionnel)</label><input type="text" class="fc" id="cCo" placeholder="Soci&#233;t&#233; du client"></div>
</div>
<div class="fg"><label>Adresse du client</label><input type="text" class="fc" id="cAd" placeholder="Num&#233;ro et rue"></div>
<div class="fr">
<div class="fg"><label>Code Postal</label><input type="text" class="fc" id="cCp" placeholder="Ex: 94000" maxlength="5" oninput="lookupCP(this.value)"><div id="cpStatus" style="font-size:.78rem;margin-top:.2rem;color:var(--g500)"></div></div>
<div class="fg"><label>Ville</label><input type="text" class="fc" id="cVi" placeholder="Ville (auto)" readonly style="background:var(--g50)"></div>
</div>
</div>
<div class="card">
<div class="ct"><i class="fas fa-file-alt"></i> Type de Document</div>
<div class="fr">
<div class="fg"><label>Type</label><select class="fc" id="pTy"><option value="devis">Devis simple (mat&#233;riel uniquement)</option><option value="devis-mo">Devis + Main d'oeuvre</option><option value="facture" selected>Facture compl&#232;te avec TVA</option></select></div>
<div class="fg"><label>Num&#233;ro</label><input type="text" class="fc" id="pNu" placeholder="Auto"></div>
</div>
<div class="fr">
<div class="fg"><label>Date</label><input type="date" class="fc" id="pDa"></div>
<div class="fg"><label>Taux TVA (%)</label><select class="fc" id="pTv"><option value="20" selected>20% (taux normal)</option><option value="10">10% (taux interm&#233;diaire)</option><option value="5.5">5,5% (taux r&#233;duit)</option><option value="0">0% (exon&#233;r&#233;)</option></select></div>
</div>
</div>
<div class="card">
<div class="ct"><i class="fas fa-hard-hat"></i> Main d'oeuvre</div>
<div class="alert al-i"><i class="fas fa-info-circle"></i> Incluse pour &#171; Devis + MO &#187; et &#171; Facture compl&#232;te &#187;</div>
<div class="fr">
<div class="fg"><label>Taux horaire (&#8364;/h)</label><input type="number" class="fc" id="pHr" value="45" step="0.5" min="0"></div>
<div class="fg"><label>Nombre d'heures</label><input type="number" class="fc" id="pHs" value="8" step="0.5" min="0"></div>
</div>
<div class="fg"><label>Description des travaux</label><textarea class="fc" id="pWd" rows="3">Installation &#233;lectrique conforme NFC 15-100</textarea></div>
</div>
<div class="card">
<div class="ct"><i class="fas fa-percent"></i> Remise (optionnel)</div>
<div class="fr">
<div class="fg"><label>Type de remise</label><select class="fc" id="rTy"><option value="none">Aucune remise</option><option value="percent">Pourcentage (%)</option><option value="fixed">Montant fixe (&#8364;)</option></select></div>
<div class="fg"><label>Valeur</label><input type="number" class="fc" id="rVa" value="0" step="0.01" min="0"></div>
</div>
</div>
<div style="text-align:center;margin-top:1rem"><button class="btn btn-pri btn-lg" onclick="genDoc()"><i class="fas fa-magic"></i> G&#233;n&#233;rer le document</button></div>
</div>

<!-- ========== DOCUMENT ========== -->
<div class="pnl" id="panel-document">
<div class="ab np">
<button class="btn btn-pri" onclick="window.print()"><i class="fas fa-print"></i> Imprimer / PDF</button>
<button class="btn btn-suc" onclick="expWord()"><i class="fas fa-file-word"></i> Export Word</button>
<button class="btn btn-acc" onclick="expExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
<button class="btn btn-out" onclick="switchTab('params')"><i class="fas fa-edit"></i> Modifier</button>
</div>
<div id="docC"><div class="es"><i class="fas fa-file-invoice"></i><p>Aucun document g&#233;n&#233;r&#233;</p><p style="font-size:.85rem">Ajoutez du mat&#233;riel puis configurez les param&#232;tres</p></div></div>
</div>

</div>

<!-- Modal suppression -->
<div class="mov" id="mDel">
<div class="mod">
<h3><i class="fas fa-exclamation-triangle" style="color:var(--dan)"></i> Confirmation</h3>
<p>Supprimer tous les articles de la liste ?</p>
<div class="moa"><button class="btn btn-out" onclick="closeMo('mDel')">Annuler</button><button class="btn btn-dan" onclick="doClear()">Supprimer tout</button></div>
</div>
</div>

<script>
// === 6 ENTREPRISES FICTIVES AVEC LOGOS SVG ===
var ENTREPRISES = [
  {
    id:'voltaelec', name:'VOLTA\u00c9LEC', slogan:'L\u2019\u00e9nergie ma\u00eetris\u00e9e',
    address:'12 rue Amp\u00e8re, 94000 Cr\u00e9teil', phone:'01 48 99 12 34', email:'contact@voltaelec.fr',
    siret:'412 345 678 00012', color:'#e63946',
    logo:'<svg viewBox="0 0 70 70"><circle cx="35" cy="35" r="32" fill="#e63946"/><path d="M38 12L22 40h12L28 58l20-30H36z" fill="#fff"/></svg>'
  },
  {
    id:'ohmservices', name:'OHM SERVICES', slogan:'Solutions \u00e9lectriques durables',
    address:'8 avenue Faraday, 77100 Meaux', phone:'01 60 25 67 89', email:'info@ohmservices.fr',
    siret:'523 456 789 00023', color:'#2a9d8f',
    logo:'<svg viewBox="0 0 70 70"><rect x="3" y="3" width="64" height="64" rx="12" fill="#2a9d8f"/><text x="35" y="44" font-family="Arial" font-size="28" font-weight="bold" fill="#fff" text-anchor="middle">\u2126</text></svg>'
  },
  {
    id:'wattplus', name:'WATT+', slogan:'Plus de puissance, plus de s\u00e9curit\u00e9',
    address:'25 bd Tesla, 93200 Saint-Denis', phone:'01 42 35 78 90', email:'devis@wattplus.fr',
    siret:'634 567 890 00034', color:'#e9c46a',
    logo:'<svg viewBox="0 0 70 70"><polygon points="35,3 67,35 35,67 3,35" fill="#e9c46a"/><text x="35" y="42" font-family="Arial" font-size="22" font-weight="bold" fill="#1d3557" text-anchor="middle">W+</text></svg>'
  },
  {
    id:'eclairpro', name:'\u00c9CLAIR PRO', slogan:'Votre \u00e9lectricien de confiance',
    address:'3 rue Volta, 91000 \u00c9vry', phone:'01 69 88 45 12', email:'contact@eclairpro.fr',
    siret:'745 678 901 00045', color:'#457b9d',
    logo:'<svg viewBox="0 0 70 70"><circle cx="35" cy="35" r="32" fill="#457b9d"/><circle cx="35" cy="35" r="18" fill="none" stroke="#fff" stroke-width="3"/><line x1="35" y1="17" x2="35" y2="25" stroke="#fff" stroke-width="3"/><line x1="35" y1="45" x2="35" y2="53" stroke="#fff" stroke-width="3"/><line x1="17" y1="35" x2="25" y2="35" stroke="#fff" stroke-width="3"/><line x1="45" y1="35" x2="53" y2="35" stroke="#fff" stroke-width="3"/><circle cx="35" cy="35" r="5" fill="#e9c46a"/></svg>'
  },
  {
    id:'ampereelec', name:'AMP\u00c8RE \u00c9LECTRIQUE', slogan:'Du courant \u00e0 la lumi\u00e8re',
    address:'17 rue Edison, 78000 Versailles', phone:'01 39 50 23 67', email:'pro@ampere-elec.fr',
    siret:'856 789 012 00056', color:'#6a4c93',
    logo:'<svg viewBox="0 0 70 70"><rect x="3" y="3" width="64" height="64" rx="16" fill="#6a4c93"/><text x="35" y="42" font-family="Arial" font-size="26" font-weight="bold" fill="#fff" text-anchor="middle">A</text><line x1="20" y1="52" x2="50" y2="52" stroke="#e9c46a" stroke-width="3"/></svg>'
  },
  {
    id:'courantech', name:'COURANTECH', slogan:'Innovation \u00e9lectrique',
    address:'42 rue Coulomb, 95100 Argenteuil', phone:'01 34 11 89 56', email:'hello@courantech.fr',
    siret:'967 890 123 00067', color:'#264653',
    logo:'<svg viewBox="0 0 70 70"><circle cx="35" cy="35" r="32" fill="#264653"/><path d="M20 35 Q25 20 35 20 Q45 20 50 35 Q45 50 35 50 Q25 50 20 35Z" fill="none" stroke="#2a9d8f" stroke-width="3"/><circle cx="35" cy="35" r="6" fill="#e76f51"/></svg>'
  }
];

var items=[], filt=null, docOk=false, selEnt=null;

function switchTab(n){
  document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});
  document.querySelectorAll('.pnl').forEach(function(p){p.classList.remove('active')});
  document.querySelector('[data-tab="'+n+'"]').classList.add('active');
  document.getElementById('panel-'+n).classList.add('active');
  if(n==='materiel') renderT();
}

// === CSV PARSING (RS Components format) ===
function handleFile(e){
  var f=e.target.files[0]; if(!f) return;
  var r=new FileReader();
  r.onload=function(ev){ parseCSV(ev.target.result) };
  r.readAsText(f,'UTF-8');
}

function setupDZ(){
  var dz=document.getElementById('dropz');
  dz.addEventListener('dragover',function(e){e.preventDefault();dz.classList.add('over')});
  dz.addEventListener('dragleave',function(){dz.classList.remove('over')});
  dz.addEventListener('drop',function(e){
    e.preventDefault();dz.classList.remove('over');
    var f=e.dataTransfer.files[0];
    if(f){var r=new FileReader();r.onload=function(ev){parseCSV(ev.target.result)};r.readAsText(f,'UTF-8')}
  });
}

function parseCSV(text){
  var lines=text.split(/\r?\n/).filter(function(l){return l.trim()});
  if(lines.length<2){showIR('w','Fichier vide ou invalide.');return}
  var fl=lines[0];
  var d=fl.indexOf('\t')>=0?'\t':(fl.split(';').length>fl.split(',').length?';':',');
  var hdrs=pLine(fl,d).map(function(h){return h.trim().toLowerCase().replace(/^\ufeff/,'')});
  var cm=detCols(hdrs);
  var imp=0, skip=0;
  for(var i=1;i<lines.length;i++){
    var v=pLine(lines[i],d);
    if(v.length<2){skip++;continue}
    var ref=cm.ref>=0?(v[cm.ref]||'').trim().replace(/^"|"$/g,''):'';
    var nm=cm.name>=0?(v[cm.name]||'').trim().replace(/^"|"$/g,''):'';
    var pr=cm.price>=0?pPr(v[cm.price]):0;
    var qt=cm.qty>=0?(parseInt(v[cm.qty].replace(/"/g,''))||1):1;
    var mfr=cm.mfr>=0?(v[cm.mfr]||'').trim().replace(/^"|"$/g,''):'';
    if(!nm&&!ref){skip++;continue}
    items.push({id:gid(),ref:ref||'-',name:nm||'Article',price:pr,qty:qt,mfr:mfr,src:'rs'});
    imp++;
  }
  updB();
  showIR('s','<strong>'+imp+' article(s)</strong> import\u00e9(s) avec succ\u00e8s !'+(skip>0?' ('+skip+' ligne(s) ignor\u00e9e(s))':''));
}

function pLine(l,d){
  var r=[],c='',q=false;
  for(var i=0;i<l.length;i++){
    if(l[i]==='"') q=!q;
    else if(l[i]===d&&!q){r.push(c);c=''}
    else c+=l[i];
  }
  r.push(c);return r;
}

function detCols(h){
  var m={ref:-1,name:-1,price:-1,qty:-1,mfr:-1};
  h.forEach(function(x,i){
    var s=x.replace(/['"]/g,'').trim();
    if(m.ref<0&&(/stock\s*no|r[eé]f|ref|sku|num|part\b/i.test(s)))m.ref=i;
    if(m.name<0&&/description|d[eé]signation|nom|article|produit|libell/i.test(s))m.name=i;
    if(m.price<0&&/unit\s*price|prix\s*unit|tarif|p\.?u\.?\s*h\.?t|unit price/i.test(s))m.price=i;
    if(m.qty<0&&/quantit[eéy]|qty|qt[eé]|qte|nombre|nb/i.test(s))m.qty=i;
    if(m.mfr<0&&/manufacturer\s*name|fabricant|marque/i.test(s))m.mfr=i;
  });
  if(m.name<0) h.forEach(function(x,i){if(m.name<0&&/description/i.test(x))m.name=i});
  if(m.ref<0&&h.length>=1)m.ref=0;
  if(m.name<0&&h.length>=6)m.name=5;
  return m;
}

function pPr(v){if(!v)return 0;return parseFloat(v.replace(/["\u20ac$\u00a3\s]/g,'').replace(',','.').trim())||0}

function showIR(t,msg){
  var c=t==='s'?'al-s':'al-w',ic=t==='s'?'check-circle':'exclamation-triangle';
  document.getElementById('impRes').innerHTML='<div class="alert '+c+'"><i class="fas fa-'+ic+'"></i> '+msg+'</div>';
}

// === MANUAL ADD ===
function addManual(){
  var nm=document.getElementById('aName').value.trim();
  if(!nm){alert('Saisissez une d\u00e9signation.');return}
  items.push({id:gid(),ref:document.getElementById('aRef').value.trim()||'-',name:nm,
    price:parseFloat(document.getElementById('aPrice').value)||0,
    qty:parseInt(document.getElementById('aQty').value)||1,mfr:'-',src:'man'});
  document.getElementById('aRef').value='';document.getElementById('aName').value='';
  document.getElementById('aPrice').value='';document.getElementById('aQty').value='1';
  updB();showIR('s','<strong>'+esc(nm)+'</strong> ajout\u00e9 \u00e0 la liste.');
}

// === MATERIEL TABLE ===
function renderT(){
  var tb=document.getElementById('tBody'),em=document.getElementById('emSt'),su=document.getElementById('sumBox');
  var ds=filt!==null?filt:items;
  if(!items.length){tb.innerHTML='';em.style.display='block';su.style.display='none';return}
  em.style.display='none';su.style.display='block';
  tb.innerHTML=ds.map(function(it){
    return '<tr><td><span class="rb">'+esc(it.ref)+'</span></td><td>'+esc(it.name)+
    '</td><td>'+esc(it.mfr||'-')+'</td><td><span class="tag '+(it.src==='rs'?'tag-rs':'tag-m')+'">'+(it.src==='rs'?'RS':'Manuel')+
    '</span></td><td style="text-align:center"><input type="number" class="qi" value="'+it.qty+
    '" min="1" onchange="uQty(\''+it.id+'\',this.value)"></td><td style="text-align:right">'+
    fmt(it.price)+'</td><td style="text-align:right" class="price">'+fmt(it.price*it.qty)+
    '</td><td style="text-align:center"><button class="btn btn-dan btn-sm" onclick="remIt(\''+it.id+
    '\')"><i class="fas fa-times"></i></button></td></tr>';
  }).join('');
  document.getElementById('sArt').textContent=items.reduce(function(s,i){return s+i.qty},0);
  document.getElementById('sMat').textContent=fmt(items.reduce(function(s,i){return s+i.price*i.qty},0));
}
function uQty(id,v){var it=items.find(function(i){return i.id===id});if(it){it.qty=Math.max(1,parseInt(v)||1);renderT()}}
function remIt(id){items=items.filter(function(i){return i.id!==id});updB();renderT()}
function clearAll(){if(!items.length)return;document.getElementById('mDel').classList.add('active')}
function doClear(){items=[];updB();renderT();closeMo('mDel')}
function closeMo(id){document.getElementById(id).classList.remove('active')}
function filterM(q){filt=q?items.filter(function(i){return i.name.toLowerCase().indexOf(q.toLowerCase())>=0||i.ref.toLowerCase().indexOf(q.toLowerCase())>=0}):null;renderT()}

// === ENTREPRISE SELECTION ===
function renderEnts(){
  var g=document.getElementById('entGrid');
  g.innerHTML=ENTREPRISES.map(function(e){
    return '<div class="ent-card'+(selEnt&&selEnt.id===e.id?' sel':'')+'" onclick="pickEnt(\''+e.id+'\')" id="ec-'+e.id+'">'+
    '<div class="logo-svg">'+e.logo+'</div><h3>'+e.name+'</h3><p>'+e.slogan+'</p></div>';
  }).join('');
}
function pickEnt(id){
  selEnt=ENTREPRISES.find(function(e){return e.id===id});
  document.querySelectorAll('.ent-card').forEach(function(c){c.classList.remove('sel')});
  document.getElementById('ec-'+id).classList.add('sel');
  // Fill fields
  document.getElementById('pCo').value=selEnt.name;
  document.getElementById('pSi').value=selEnt.siret;
  document.getElementById('pAd').value=selEnt.address;
  document.getElementById('pPh').value=selEnt.phone;
  document.getElementById('pEm').value=selEnt.email;
}

// === DOCUMENT GENERATION ===
function genDoc(){
  if(!items.length){alert('Ajoutez du mat\u00e9riel d\'abord.');return}
  var dt=document.getElementById('pTy').value;
  var tr=parseFloat(document.getElementById('pTv').value)/100;
  var co=document.getElementById('pCo').value||'Mon Entreprise';
  var si=document.getElementById('pSi').value;
  var ad=document.getElementById('pAd').value;
  var ph=document.getElementById('pPh').value;
  var em=document.getElementById('pEm').value;
  var cn=document.getElementById('cNm').value||'Client';
  var cc=document.getElementById('cCo').value;
  var ca=document.getElementById('cAd').value;
  var ccp=document.getElementById('cCp').value;
  var cvi=document.getElementById('cVi').value;
  var fullAddr=ca;
  if(ccp||cvi) fullAddr+=(ca?', ':'')+ccp+' '+cvi;
  var dd=document.getElementById('pDa').value||new Date().toISOString().split('T')[0];
  var dn=document.getElementById('pNu').value;
  var hr=parseFloat(document.getElementById('pHr').value)||0;
  var hs=parseFloat(document.getElementById('pHs').value)||0;
  var wd=document.getElementById('pWd').value;
  var rty=document.getElementById('rTy').value;
  var rva=parseFloat(document.getElementById('rVa').value)||0;

  if(!dn){dn=(dt==='facture'?'FA':'DV')+'-'+new Date().getFullYear()+'-'+String(Math.floor(Math.random()*9999)).padStart(4,'0');document.getElementById('pNu').value=dn}

  var tl=dt==='facture'?'FACTURE':'DEVIS';
  var tm=items.reduce(function(s,i){return s+i.price*i.qty},0);
  var tmo=dt!=='devis'?hr*hs:0;
  var sub=tm+tmo;
  var disc=rty==='percent'?sub*(rva/100):rty==='fixed'?rva:0;
  var tht=sub-disc;
  var tva=dt==='facture'?tht*tr:0;
  var ttc=tht+tva;
  var fd=function(d){var p=d.split('-');return p[2]+'/'+p[1]+'/'+p[0]};

  // Logo
  var logoHtml='';
  if(selEnt) logoHtml='<div class="logo-svg">'+selEnt.logo+'</div>';

  var rows=items.map(function(it,idx){
    return '<tr><td style="text-align:center">'+(idx+1)+'</td><td><span style="font-family:monospace;font-size:.8rem;color:#666">'+
    esc(it.ref)+'</span></td><td>'+esc(it.name)+'</td><td style="text-align:center">'+it.qty+
    '</td><td style="text-align:right">'+fmt(it.price)+'</td><td style="text-align:right;font-weight:600">'+fmt(it.price*it.qty)+'</td></tr>';
  }).join('');

  if(dt!=='devis'&&tmo>0){
    rows+='<tr style="background:#f0f9ff"><td style="text-align:center">'+(items.length+1)+
    '</td><td>-</td><td><strong>Main d\u2019\u0153uvre</strong> - '+esc(wd)+
    '</td><td style="text-align:center">'+hs+'h</td><td style="text-align:right">'+fmt(hr)+
    '/h</td><td style="text-align:right;font-weight:600">'+fmt(tmo)+'</td></tr>';
  }

  var h='<div class="dp" id="docP"><div class="dh"><div class="dco">'+logoHtml+'<div class="info"><h2>'+esc(co)+'</h2>'+
    (ad?'<p>'+esc(ad)+'</p>':'')+(ph?'<p>T\u00e9l: '+esc(ph)+'</p>':'')+
    (em?'<p>'+esc(em)+'</p>':'')+(si?'<p style="font-size:.78rem;margin-top:.2rem">SIRET: '+esc(si)+'</p>':'')+
    '</div></div><div class="dty"><h3>'+tl+'</h3><div class="dn">N\u00b0 '+esc(dn)+'</div><div class="dd">Date: '+fd(dd)+'</div>'+
    (dt!=='facture'?'<div class="dd">Validit\u00e9: 30 jours</div>':'')+'</div></div>';

  h+='<div class="dcb"><h4>Client</h4><strong>'+esc(cn)+'</strong>'+(cc?'<br>'+esc(cc):'')+(fullAddr?'<br>'+esc(fullAddr):'')+'</div>';
  if(dt!=='devis'&&wd) h+='<p style="margin-bottom:1rem;font-style:italic;color:#555">Objet : '+esc(wd)+'</p>';

  h+='<table class="dtb"><thead><tr><th style="text-align:center;width:40px">N\u00b0</th><th style="width:80px">R\u00e9f.</th><th>D\u00e9signation</th><th style="text-align:center;width:50px">Qt\u00e9</th><th style="text-align:right;width:85px">P.U. HT</th><th style="text-align:right;width:95px">Total HT</th></tr></thead><tbody>'+rows+'</tbody></table>';

  h+='<div class="tots">';
  h+='<div class="rw"><span>Total Mat\u00e9riel HT</span><span>'+fmt(tm)+'</span></div>';
  if(tmo>0) h+='<div class="rw"><span>Main d\u2019\u0153uvre HT</span><span>'+fmt(tmo)+'</span></div>';
  if(disc>0) h+='<div class="rw"><span>Remise'+(rty==='percent'?' ('+rva+'%)':'')+'</span><span>- '+fmt(disc)+'</span></div>';
  h+='<div class="rw" style="font-weight:600"><span>Total HT</span><span>'+fmt(tht)+'</span></div>';
  if(dt==='facture') h+='<div class="rw"><span>TVA ('+(tr*100).toFixed(1)+'%)</span><span>'+fmt(tva)+'</span></div>';
  h+='<div class="rw grand"><span>Total '+(dt==='facture'?'TTC':'HT')+'</span><span>'+fmt(dt==='facture'?ttc:tht)+'</span></div></div>';

  if(dt==='facture') h+='<div style="margin-top:1.5rem;padding:.8rem;background:#f9fafb;border-radius:8px;font-size:.8rem;color:#666"><strong>Conditions de paiement :</strong> Paiement \u00e0 30 jours \u00e0 r\u00e9ception de facture.<br><strong>P\u00e9nalit\u00e9s de retard :</strong> 3 fois le taux d\u2019int\u00e9r\u00eat l\u00e9gal. Indemnit\u00e9 forfaitaire de recouvrement : 40 \u20ac.</div>';
  if(dt.indexOf('devis')>=0) h+='<div style="margin-top:1.5rem;padding:.8rem;background:#f9fafb;border-radius:8px;font-size:.8rem;color:#666"><strong>Bon pour accord :</strong><br><br>Date : ________________\u00a0\u00a0\u00a0\u00a0Signature : ________________</div>';

  h+='<div class="df">'+esc(co)+(si?' \u2022 SIRET: '+esc(si):'')+'<br>Document g\u00e9n\u00e9r\u00e9 avec MELEC - Devis &amp; Facturation</div></div>';

  document.getElementById('docC').innerHTML=h;
  docOk=true;
  switchTab('document');
}

// === EXPORTS ===
function expWord(){
  var c=document.getElementById('docP');
  if(!c){alert('G\u00e9n\u00e9rez le document d\'abord.');return}
  var h='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><style>body{font-family:Calibri,sans-serif;font-size:11pt}table{border-collapse:collapse;width:100%}th{background:#1a56db;color:#fff;padding:6px 8px;font-size:9pt}td{padding:5px 8px;border-bottom:1px solid #ddd;font-size:10pt}h2{color:#1a56db}h3{color:#1e40af}</style></head><body>'+c.innerHTML+'</body></html>';
  dlB(new Blob(['\ufeff',h],{type:'application/msword'}),gfn('.doc'));
}

function expExcel(){
  var dt=document.getElementById('pTy').value;
  var tr=parseFloat(document.getElementById('pTv').value)/100;
  var hr=parseFloat(document.getElementById('pHr').value)||0;
  var hs=parseFloat(document.getElementById('pHs').value)||0;
  var csv='\ufeffN\u00b0;R\u00e9f\u00e9rence;D\u00e9signation;Fabricant;Quantit\u00e9;Prix Unitaire HT;Total HT\n';
  items.forEach(function(it,idx){
    csv+=(idx+1)+';'+it.ref+';'+it.name.replace(/;/g,',')+';'+(it.mfr||'-')+';'+it.qty+';'+it.price.toFixed(2)+';'+(it.price*it.qty).toFixed(2)+'\n';
  });
  if(dt!=='devis'&&hr>0&&hs>0) csv+=(items.length+1)+';-;Main d\'oeuvre;-;'+hs+'h;'+hr.toFixed(2)+';'+(hr*hs).toFixed(2)+'\n';
  var tm=items.reduce(function(s,i){return s+i.price*i.qty},0);
  var tmo=dt!=='devis'?hr*hs:0, tht=tm+tmo, tv=dt==='facture'?tht*tr:0;
  csv+='\n;;;TOTAL MAT\u00c9RIEL HT;;;;'+tm.toFixed(2)+'\n';
  if(tmo>0) csv+=';;;MAIN D\'OEUVRE HT;;;;'+tmo.toFixed(2)+'\n';
  csv+=';;;TOTAL HT;;;;'+tht.toFixed(2)+'\n';
  if(dt==='facture'){csv+=';;;TVA ('+(tr*100).toFixed(1)+'%);;;;'+tv.toFixed(2)+'\n';csv+=';;;TOTAL TTC;;;;'+(tht+tv).toFixed(2)+'\n'}
  dlB(new Blob([csv],{type:'text/csv;charset=utf-8;'}),gfn('.csv'));
}

// === UTILS ===
function gid(){return 'i'+Math.random().toString(36).substr(2,9)}
function fmt(v){return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(v)}
function esc(s){if(!s)return '';var d=document.createElement('div');d.textContent=s;return d.innerHTML}
function updB(){document.getElementById('bc').textContent=items.length}
function gfn(e){var t=document.getElementById('pTy').value;var n=document.getElementById('pNu').value||'doc';return(t==='facture'?'Facture':'Devis')+'_'+n+e}
function dlB(b,n){var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click();URL.revokeObjectURL(a.href)}

function resetAll(){
  if(items.length>0&&!confirm('R\u00e9initialiser ? Toutes les donn\u00e9es seront perdues.'))return;
  items=[];filt=null;docOk=false;updB();
  document.getElementById('docC').innerHTML='<div class="es"><i class="fas fa-file-invoice"></i><p>Aucun document g\u00e9n\u00e9r\u00e9</p></div>';
  document.getElementById('impRes').innerHTML='';
  switchTab('params');
}

// === CODE POSTAL -> VILLE (API geo.api.gouv.fr) ===
var cpTimeout=null;
function lookupCP(val){
  var st=document.getElementById('cpStatus');
  var vi=document.getElementById('cVi');
  val=val.replace(/\D/g,'');
  document.getElementById('cCp').value=val;
  if(val.length<5){vi.value='';st.innerHTML='';vi.readOnly=true;vi.style.background='var(--g50)';return}
  if(val.length===5){
    st.innerHTML='<i class="fas fa-spinner fa-spin"></i> Recherche...';
    if(cpTimeout) clearTimeout(cpTimeout);
    cpTimeout=setTimeout(function(){
      fetch('https://geo.api.gouv.fr/communes?codePostal='+val+'&fields=nom&limit=10')
      .then(function(r){return r.json()})
      .then(function(data){
        if(data.length===0){
          st.innerHTML='<span style="color:var(--dan)"><i class="fas fa-times-circle"></i> Code postal non trouv\u00e9</span>';
          vi.value='';vi.readOnly=true;vi.style.background='var(--g50)';
        } else if(data.length===1){
          vi.value=data[0].nom;
          vi.readOnly=true;vi.style.background='var(--g50)';
          st.innerHTML='<span style="color:var(--suc)"><i class="fas fa-check-circle"></i> '+data[0].nom+'</span>';
        } else {
          // Multiple cities for this CP - show select
          vi.readOnly=false;vi.style.background='#fff';
          vi.value=data[0].nom;
          var opts=data.map(function(c){return c.nom}).join(', ');
          st.innerHTML='<span style="color:var(--pri)"><i class="fas fa-info-circle"></i> Plusieurs villes : '+opts+'</span>';
        }
      })
      .catch(function(){
        st.innerHTML='<span style="color:var(--dan)"><i class="fas fa-wifi-slash"></i> Hors ligne - saisissez la ville manuellement</span>';
        vi.readOnly=false;vi.style.background='#fff';
      });
    },300);
  }
}

// INIT
document.addEventListener('DOMContentLoaded',function(){
  document.getElementById('pDa').value=new Date().toISOString().split('T')[0];
  setupDZ();
  renderEnts();
});

</script>
</body>
</html>
