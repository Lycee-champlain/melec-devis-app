<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MELEC PRO - Devis et Facturation</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
:root{
  --pri:#2563eb;--pl:#3b82f6;--pd:#1d4ed8;--pri-bg:#eff6ff;--pri-ring:rgba(37,99,235,.15);
  --acc:#f59e0b;--acc-bg:#fffbeb;
  --suc:#059669;--suc-bg:#ecfdf5;--suc-ring:rgba(5,150,105,.12);
  --dan:#dc2626;--dan-bg:#fef2f2;--dan-ring:rgba(220,38,38,.12);
  --g0:#fff;--g50:#f8fafc;--g100:#f1f5f9;--g200:#e2e8f0;--g300:#cbd5e1;--g400:#94a3b8;--g500:#64748b;--g600:#475569;--g700:#334155;--g800:#1e293b;--g900:#0f172a;
  --r:12px;--r-sm:8px;--r-lg:16px;
  --sh-sm:0 1px 2px rgba(0,0,0,.05);--sh:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.04);--sh-md:0 4px 6px -1px rgba(0,0,0,.08),0 2px 4px -2px rgba(0,0,0,.04);--sh-lg:0 10px 15px -3px rgba(0,0,0,.08),0 4px 6px -4px rgba(0,0,0,.03);--sh-xl:0 20px 25px -5px rgba(0,0,0,.08),0 8px 10px -6px rgba(0,0,0,.03);
  --trans:all .2s cubic-bezier(.4,0,.2,1);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#f0f4ff 0%,#e8ecf4 50%,#f0f4ff 100%);color:var(--g800);line-height:1.6;min-height:100vh}

/* === SIDEBAR LAYOUT === */
.app{display:flex;min-height:100vh}
.sidebar{width:260px;background:var(--g900);color:#fff;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:transform .3s}
.sb-hdr{padding:1.5rem 1.25rem;border-bottom:1px solid rgba(255,255,255,.08)}
.sb-logo{display:flex;align-items:center;gap:.75rem}
.sb-logo svg{flex-shrink:0}
.sb-logo h1{font-size:1.05rem;font-weight:800;letter-spacing:-.02em;line-height:1.2}
.sb-logo small{font-size:.7rem;font-weight:400;opacity:.5;display:block;margin-top:2px}
.sb-nav{flex:1;padding:.75rem .75rem;display:flex;flex-direction:column;gap:4px}
.sb-item{display:flex;align-items:center;gap:.75rem;padding:.7rem 1rem;border-radius:var(--r-sm);cursor:pointer;font-weight:500;font-size:.88rem;color:rgba(255,255,255,.55);transition:var(--trans);position:relative;user-select:none}
.sb-item:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.85)}
.sb-item.active{background:var(--pri);color:#fff;box-shadow:0 4px 12px rgba(37,99,235,.35)}
.sb-item i{width:20px;text-align:center;font-size:.95rem}
.sb-item .badge{margin-left:auto;background:rgba(255,255,255,.15);font-size:.7rem;padding:.1rem .5rem;border-radius:10px;font-weight:700;min-width:22px;text-align:center}
.sb-item.active .badge{background:rgba(255,255,255,.25)}
.sb-sep{height:1px;background:rgba(255,255,255,.06);margin:.5rem .5rem}
.sb-foot{padding:1rem 1.25rem;border-top:1px solid rgba(255,255,255,.06);font-size:.72rem;color:rgba(255,255,255,.25);text-align:center}
.sb-foot span{color:var(--pl)}

/* === MAIN AREA === */
.content{margin-left:260px;flex:1;min-height:100vh;display:flex;flex-direction:column}
.topbar{background:var(--g0);border-bottom:1px solid var(--g200);padding:.85rem 2rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40;backdrop-filter:blur(8px);background:rgba(255,255,255,.85)}
.topbar-title{font-size:1.15rem;font-weight:700;color:var(--g900);display:flex;align-items:center;gap:.5rem}
.topbar-title i{color:var(--pri);font-size:1rem}
.topbar-actions{display:flex;gap:.5rem}
.page{flex:1;padding:2rem;max-width:1300px;width:100%}
.pnl{display:none;animation:fadeIn .3s ease}.pnl.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* === CARDS === */
.card{background:var(--g0);border-radius:var(--r);border:1px solid var(--g200);padding:1.5rem;margin-bottom:1.25rem;transition:var(--trans)}
.card:hover{box-shadow:var(--sh-md)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem}
.ct{font-size:1rem;font-weight:700;display:flex;align-items:center;gap:.6rem;color:var(--g800)}
.ct i{color:var(--pri);font-size:1.1rem;width:22px;text-align:center}
.ct .ct-badge{font-size:.7rem;background:var(--pri-bg);color:var(--pri);padding:.2rem .6rem;border-radius:20px;font-weight:600;margin-left:.3rem}

/* === BUTTONS === */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.55rem 1.15rem;border-radius:var(--r-sm);font-weight:600;font-size:.85rem;border:none;cursor:pointer;transition:var(--trans);font-family:inherit;line-height:1.4}
.btn-pri{background:var(--pri);color:#fff;box-shadow:0 1px 3px rgba(37,99,235,.3)}.btn-pri:hover{background:var(--pd);box-shadow:0 4px 12px rgba(37,99,235,.3);transform:translateY(-1px)}
.btn-suc{background:var(--suc);color:#fff;box-shadow:0 1px 3px rgba(5,150,105,.3)}.btn-suc:hover{background:#047857;transform:translateY(-1px)}
.btn-dan{background:var(--dan);color:#fff}.btn-dan:hover{background:#b91c1c}
.btn-acc{background:var(--acc);color:#fff}.btn-acc:hover{background:#d97706}
.btn-ghost{background:transparent;color:var(--g600);border:1px solid var(--g200)}.btn-ghost:hover{background:var(--g50);border-color:var(--g300);color:var(--g800)}
.btn-out{background:var(--g0);color:var(--pri);border:2px solid var(--pri)}.btn-out:hover{background:var(--pri);color:#fff}
.btn-sm{padding:.35rem .75rem;font-size:.8rem;border-radius:6px}.btn-lg{padding:.75rem 2rem;font-size:.95rem;border-radius:var(--r)}
.btn-icon{width:36px;height:36px;padding:0;border-radius:var(--r-sm);display:inline-flex;align-items:center;justify-content:center}

/* === FORMS === */
.fg{margin-bottom:1rem}
.fg label{display:block;font-weight:600;font-size:.82rem;margin-bottom:.35rem;color:var(--g600);letter-spacing:.01em}
.fc{width:100%;padding:.6rem .85rem;border:1.5px solid var(--g200);border-radius:var(--r-sm);font-size:.88rem;transition:var(--trans);font-family:inherit;background:var(--g0);color:var(--g800)}
.fc:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 3px var(--pri-ring)}
.fc::placeholder{color:var(--g400)}
select.fc{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .8rem center;padding-right:2.2rem}
textarea.fc{resize:vertical;min-height:70px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:1rem}

/* === DROPZONE === */
.dz{border:2px dashed var(--g300);border-radius:var(--r-lg);padding:3rem 2rem;text-align:center;cursor:pointer;transition:var(--trans);background:var(--g50);position:relative}
.dz:hover{border-color:var(--pl);background:var(--pri-bg)}
.dz.over{border-color:var(--pri);background:var(--pri-bg);box-shadow:0 0 0 4px var(--pri-ring)}
.dz-icon{width:64px;height:64px;border-radius:50%;background:var(--pri-bg);display:flex;align-items:center;justify-content:center;margin:0 auto 1rem}
.dz-icon i{font-size:1.5rem;color:var(--pri)}
.dz .mt{font-weight:700;color:var(--g800);font-size:1.05rem;margin-bottom:.25rem}
.dz p{color:var(--g500);font-size:.88rem}
.dz .mt span{color:var(--pri);text-decoration:underline}

/* === TABLES === */
.tc{overflow-x:auto;border-radius:var(--r-sm);border:1px solid var(--g200)}
table{width:100%;border-collapse:collapse;font-size:.85rem}
thead{background:var(--g50)}
th{padding:.65rem .85rem;text-align:left;font-weight:600;color:var(--g600);font-size:.78rem;text-transform:uppercase;letter-spacing:.04em;border-bottom:2px solid var(--g200)}
td{padding:.6rem .85rem;border-bottom:1px solid var(--g100);vertical-align:middle}
tbody tr{transition:var(--trans)}tbody tr:hover{background:var(--pri-bg)}
tbody tr:last-child td{border-bottom:none}
.qi{width:60px;padding:.3rem;border:1.5px solid var(--g200);border-radius:6px;text-align:center;font-weight:600;font-family:inherit;font-size:.85rem;transition:var(--trans)}
.qi:focus{border-color:var(--pri);outline:none;box-shadow:0 0 0 3px var(--pri-ring)}
.price{font-weight:700;color:var(--pri)}
.rb{background:var(--g100);padding:.2rem .55rem;border-radius:5px;font-family:'SF Mono',SFMono-Regular,Consolas,monospace;font-size:.78rem;color:var(--g600);font-weight:500}

/* === SUMMARY BOX === */
.sb{background:linear-gradient(135deg,var(--g900) 0%,#1e3a5f 100%);color:#fff;border-radius:var(--r);padding:1.5rem;box-shadow:var(--sh-lg)}
.sr{display:flex;justify-content:space-between;padding:.45rem 0;font-size:.95rem}
.sr .lbl{opacity:.7;font-weight:400}
.sr .val{font-weight:600}

/* === DOCUMENT PREVIEW === */
.dp{background:var(--g0);border:1px solid var(--g200);border-radius:var(--r);padding:2.5rem;max-width:850px;margin:0 auto;box-shadow:var(--sh-xl)}
.dh{display:flex;justify-content:space-between;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:3px solid var(--pri)}
.dco{display:flex;align-items:center;gap:1rem}.dco .logo-svg{width:56px;height:56px;flex-shrink:0}
.dco .info h2{color:var(--pri);font-size:1.15rem;font-weight:800;line-height:1.2}.dco .info p{font-size:.82rem;color:var(--g500);margin:1px 0}
.dty{text-align:right}.dty h3{font-size:1.4rem;color:var(--pd);text-transform:uppercase;letter-spacing:.06em;font-weight:800}
.dty .dn{font-size:.88rem;color:var(--g500);font-weight:500}.dty .dd{font-size:.82rem;color:var(--g400)}
.dcb{background:var(--g50);border-radius:var(--r-sm);padding:1rem 1.25rem;margin-bottom:1.5rem;border-left:4px solid var(--pri)}
.dcb h4{font-size:.75rem;text-transform:uppercase;color:var(--g400);margin-bottom:.3rem;letter-spacing:.05em;font-weight:600}
.dtb{width:100%;border-collapse:collapse;margin-bottom:1.5rem;border-radius:var(--r-sm);overflow:hidden}
.dtb th{background:var(--pri);color:#fff;padding:.6rem .85rem;font-size:.78rem;text-transform:uppercase;text-align:left;font-weight:600;letter-spacing:.03em}
.dtb td{padding:.55rem .85rem;border-bottom:1px solid var(--g200);font-size:.84rem}
.dtb tbody tr:nth-child(even){background:var(--g50)}
.dtb tbody tr:last-child td{border-bottom:none}
.tots{margin-left:auto;width:280px}
.tots .rw{display:flex;justify-content:space-between;padding:.4rem 0;font-size:.88rem;color:var(--g700)}
.tots .rw.grand{border-top:2px solid var(--g800);font-weight:800;font-size:1.1rem;padding-top:.7rem;margin-top:.4rem;color:var(--g900)}
.df{margin-top:2rem;padding-top:1rem;border-top:1px solid var(--g200);font-size:.78rem;color:var(--g400);text-align:center}

/* === EMPTY STATE === */
.es{text-align:center;padding:3rem 2rem;color:var(--g400)}
.es-icon{width:80px;height:80px;border-radius:50%;background:var(--g100);display:flex;align-items:center;justify-content:center;margin:0 auto 1.25rem}
.es-icon i{font-size:2rem;color:var(--g400)}
.es h3{font-size:1.1rem;font-weight:600;color:var(--g600);margin-bottom:.3rem}
.es p{font-size:.88rem;color:var(--g400);max-width:350px;margin:0 auto}

/* === ALERTS === */
.alert{padding:.75rem 1rem;border-radius:var(--r-sm);font-size:.88rem;display:flex;align-items:center;gap:.6rem;font-weight:500}
.al-i{background:var(--pri-bg);color:var(--pd);border:1px solid #bfdbfe}
.al-s{background:var(--suc-bg);color:#065f46;border:1px solid #a7f3d0}
.al-w{background:var(--acc-bg);color:#92400e;border:1px solid #fde68a}

/* === ACTION BAR === */
.ab{display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:1.25rem;align-items:center}

/* === SEARCH BAR === */
.sbar{position:relative}
.sbar input{width:100%;padding:.6rem .85rem .6rem 2.5rem;border:1.5px solid var(--g200);border-radius:var(--r-sm);font-size:.88rem;font-family:inherit;transition:var(--trans);background:var(--g0)}
.sbar input:focus{border-color:var(--pri);outline:none;box-shadow:0 0 0 3px var(--pri-ring)}
.sbar>i{position:absolute;left:.85rem;top:50%;transform:translateY(-50%);color:var(--g400);font-size:.88rem}

/* === HELP SECTION === */
.hs{background:var(--acc-bg);border:1px solid #fde68a;border-radius:var(--r);padding:1.25rem 1.5rem;margin-bottom:1.25rem}
.hs h4{color:#92400e;margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem;font-size:.92rem}
.hs ol{padding-left:1.4rem;font-size:.88rem;color:#78350f}.hs li{margin-bottom:.3rem}

/* === TAGS === */
.tag{display:inline-flex;align-items:center;padding:.2rem .6rem;border-radius:20px;font-size:.72rem;font-weight:600;letter-spacing:.02em}
.tag-rs{background:#fee2e2;color:#dc2626}.tag-m{background:var(--pri-bg);color:var(--pri)}

/* === ENTERPRISE GRID === */
.ent-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.85rem}
.ent-card{border:2px solid var(--g200);border-radius:var(--r);padding:1.15rem .75rem;cursor:pointer;transition:var(--trans);text-align:center;background:var(--g0)}
.ent-card:hover{border-color:var(--pl);background:var(--pri-bg);transform:translateY(-2px);box-shadow:var(--sh-md)}
.ent-card.sel{border-color:var(--pri);background:var(--pri-bg);box-shadow:0 0 0 3px var(--pri-ring)}
.ent-card .logo-svg{width:56px;height:56px;margin:0 auto .6rem}
.ent-card h3{font-size:.88rem;color:var(--g800);font-weight:700;margin-bottom:.15rem}
.ent-card p{font-size:.72rem;color:var(--g500);font-weight:400}

/* === MODALS === */
.mov{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15,23,42,.5);z-index:200;justify-content:center;align-items:center;backdrop-filter:blur(4px)}
.mov.active{display:flex}
.mod{background:var(--g0);border-radius:var(--r-lg);padding:2rem;width:90%;max-width:480px;box-shadow:var(--sh-xl);animation:modalIn .25s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.mod h3{margin-bottom:.5rem;font-size:1.05rem;display:flex;align-items:center;gap:.5rem}
.mod p{color:var(--g500);font-size:.9rem}
.moa{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.5rem}

/* === MOBILE TOGGLE === */
.mob-toggle{display:none;position:fixed;bottom:1.5rem;right:1.5rem;width:52px;height:52px;border-radius:50%;background:var(--pri);color:#fff;border:none;font-size:1.2rem;box-shadow:0 4px 15px rgba(37,99,235,.4);z-index:60;cursor:pointer}

/* === PRINT === */
@media print{
  @page{size:A4;margin:15mm}
  body{background:#fff!important;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
  .sidebar,.topbar,.ab,.btn,.np,.mov,.mob-toggle,#docOptions{display:none!important}
  .content{margin-left:0!important}
  .page{padding:0!important;max-width:100%!important}
  #panel-document{display:block!important}
  .dp{box-shadow:none!important;border:none!important;padding:0!important;max-width:100%!important}
  .dh{display:flex!important;border-bottom:3px solid #2563eb!important}
  .dco .logo-svg{width:50px!important;height:50px!important}
  .dtb th{background:#2563eb!important;color:#fff!important;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
  .dtb tr:nth-child(even){background:#f8fafc!important;-webkit-print-color-adjust:exact!important}
  .dcb{background:#f8fafc!important;border-left:4px solid #2563eb!important;-webkit-print-color-adjust:exact!important}
  .tots .rw.grand{border-top:2px solid #1e293b!important}
  table{page-break-inside:auto}tr{page-break-inside:avoid}
}

/* === RESPONSIVE === */
@media(max-width:900px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .content{margin-left:0}
  .mob-toggle{display:flex;align-items:center;justify-content:center}
  .ent-grid{grid-template-columns:repeat(2,1fr)}
  .fr{grid-template-columns:1fr}
  .page{padding:1rem}
  .dh{flex-direction:column;gap:1rem}.dty{text-align:left}
  .tots{width:100%}
  .dp{padding:1.5rem}
}

</style>
</head>
<body>
<div class="app">

<!-- SIDEBAR -->
<nav class="sidebar" id="sidebar">
<div class="sb-hdr">
<div class="sb-logo">
<svg width="38" height="38" viewBox="0 0 38 38"><rect width="38" height="38" rx="10" fill="#2563eb"/><path d="M21 5L10 20h7l-3 13 14-17h-7z" fill="#fff"/></svg>
<div><h1>MELEC PRO</h1><small>Devis &amp; Facturation</small></div>
</div>
</div>
<div class="sb-nav">
<div class="sb-item active" data-tab="params" onclick="switchTab('params')"><i class="fas fa-sliders-h"></i> Param&#232;tres</div>
<div class="sb-item" data-tab="import" onclick="switchTab('import')"><i class="fas fa-file-import"></i> Import RS</div>
<div class="sb-item" data-tab="materiel" onclick="switchTab('materiel')"><i class="fas fa-boxes-stacked"></i> Mat&#233;riel <span class="badge" id="bc">0</span></div>
<div class="sb-sep"></div>
<div class="sb-item" data-tab="document" onclick="switchTab('document')"><i class="fas fa-file-invoice-dollar"></i> Document</div>
</div>
<div class="sb-foot">&#169; 2026 MELEC PRO &mdash; <span>Lyc&#233;e S. de Champlain</span></div>
</nav>

<!-- MAIN CONTENT -->
<div class="content">
<div class="topbar">
<div class="topbar-title" id="topTitle"><i class="fas fa-sliders-h"></i> Param&#232;tres du projet</div>
<div class="topbar-actions">
<button class="btn btn-ghost btn-sm" onclick="resetAll()"><i class="fas fa-rotate-right"></i> R&#233;initialiser</button>
</div>
</div>
<div class="page">

<!-- ========== PARAMETRES ========== -->
<div class="pnl active" id="panel-params">
<div class="card">
<div class="card-header"><div class="ct"><i class="fas fa-building"></i> Entreprise &#233;mettrice</div><div class="ct-badge" style="font-size:.7rem;background:#eff6ff;color:#2563eb;padding:.2rem .6rem;border-radius:20px;font-weight:600">Choisir</div></div>
<p style="font-size:.88rem;color:#64748b;margin-bottom:1rem">Cliquez sur une entreprise fictive ou remplissez les champs manuellement :</p>
<div class="ent-grid" id="entGrid"></div>
</div>
<div class="card">
<div class="ct" style="margin-bottom:1.25rem"><i class="fas fa-pen-to-square"></i> D&#233;tails entreprise</div>
<div class="fr">
<div class="fg"><label>Nom de l'entreprise</label><input type="text" class="fc" id="pCo" placeholder="Ex: Mon Entreprise SARL"></div>
<div class="fg"><label>SIRET</label><input type="text" class="fc" id="pSi" placeholder="123 456 789 00012"></div>
</div>
<div class="fg"><label>Adresse</label><input type="text" class="fc" id="pAd" placeholder="12 rue de l'Industrie, 75012 Paris"></div>
<div class="fr">
<div class="fg"><label>T&#233;l&#233;phone</label><input type="text" class="fc" id="pPh" placeholder="01 23 45 67 89"></div>
<div class="fg"><label>Email</label><input type="email" class="fc" id="pEm" placeholder="contact@entreprise.fr"></div>
</div>
</div>
<div class="card">
<div class="ct" style="margin-bottom:1.25rem"><i class="fas fa-user-tie"></i> Client</div>
<div class="fr">
<div class="fg"><label>Nom du client</label><input type="text" class="fc" id="cNm" placeholder="Nom ou raison sociale"></div>
<div class="fg"><label>Soci&#233;t&#233; (optionnel)</label><input type="text" class="fc" id="cCo" placeholder="Soci&#233;t&#233;"></div>
</div>
<div class="fg"><label>Adresse</label><input type="text" class="fc" id="cAd" placeholder="Num&#233;ro et rue"></div>
<div class="fr">
<div class="fg"><label>Code Postal</label><input type="text" class="fc" id="cCp" placeholder="Ex: 94000" maxlength="5" oninput="lookupCP(this.value)"><div id="cpStatus" style="font-size:.78rem;margin-top:.3rem"></div></div>
<div class="fg"><label>Ville</label><input type="text" class="fc" id="cVi" placeholder="Ville (automatique)" readonly style="background:var(--g50)"></div>
</div>
</div>
<div class="card">
<div class="ct" style="margin-bottom:1.25rem"><i class="fas fa-helmet-safety"></i> Main d'&#339;uvre</div>
<div class="fr">
<div class="fg"><label>Taux horaire (&#8364;/h HT)</label><input type="number" class="fc" id="pHr" value="45" step="0.5" min="0"></div>
<div class="fg"><label>Nombre d'heures</label><input type="number" class="fc" id="pHs" value="8" step="0.5" min="0"></div>
</div>
<div class="fg"><label>Description des travaux</label><textarea class="fc" id="pWd" rows="2">Installation &#233;lectrique conforme NFC 15-100</textarea></div>
</div>
<div class="card">
<div class="ct" style="margin-bottom:1.25rem"><i class="fas fa-tag"></i> Remise <span style="font-size:.78rem;font-weight:400;color:var(--g400)">(optionnel)</span></div>
<div class="fr">
<div class="fg"><label>Type de remise</label><select class="fc" id="rTy"><option value="none">Aucune remise</option><option value="percent">Pourcentage (%)</option><option value="fixed">Montant fixe (&#8364;)</option></select></div>
<div class="fg"><label>Valeur</label><input type="number" class="fc" id="rVa" value="0" step="0.01" min="0"></div>
</div>
</div>
</div>

<!-- ========== IMPORT ========== -->
<div class="pnl" id="panel-import">
<div class="hs">
<h4><i class="fas fa-circle-info"></i> Comment exporter depuis RS Components ?</h4>
<ol>
<li>Allez sur <strong>fr.rs-online.com</strong> et ajoutez vos articles au panier</li>
<li>Ouvrez votre panier et cliquez sur <strong>&#171; Exporter la liste &#187;</strong></li>
<li>Enregistrez le fichier <strong>.csv</strong> sur votre ordinateur</li>
<li>Glissez-d&#233;posez le fichier ci-dessous ou cliquez pour le s&#233;lectionner</li>
</ol>
</div>
<div class="card">
<div class="ct" style="margin-bottom:1.25rem"><i class="fas fa-cloud-arrow-up"></i> Importer un fichier CSV</div>
<div class="dz" id="dropz" onclick="document.getElementById('csvF').click()">
<div class="dz-icon"><i class="fas fa-file-csv"></i></div>
<p class="mt">Glissez votre fichier ici ou <span>parcourir</span></p>
<p>Formats accept&#233;s : .csv, .txt</p>
<input type="file" id="csvF" accept=".csv,.txt" hidden onchange="handleFile(event)">
</div>
<div id="impRes" style="margin-top:1rem"></div>
</div>
<div class="card">
<div class="ct" style="margin-bottom:1.25rem"><i class="fas fa-circle-plus"></i> Ajout manuel</div>
<div class="fr">
<div class="fg"><label>R&#233;f&#233;rence RS</label><input type="text" class="fc" id="aRef" placeholder="Ex: 123-4567"></div>
<div class="fg"><label>D&#233;signation</label><input type="text" class="fc" id="aName" placeholder="Ex: Disjoncteur diff. 30mA"></div>
</div>
<div class="fr">
<div class="fg"><label>Prix unitaire HT (&#8364;)</label><input type="number" class="fc" id="aPrice" placeholder="0.00" step="0.01" min="0"></div>
<div class="fg"><label>Quantit&#233;</label><input type="number" class="fc" id="aQty" placeholder="1" min="1" value="1"></div>
</div>
<button class="btn btn-pri" onclick="addManual()"><i class="fas fa-plus"></i> Ajouter &#224; la liste</button>
</div>
</div>

<!-- ========== MATERIEL ========== -->
<div class="pnl" id="panel-materiel">
<div class="ab">
<div class="sbar" style="flex:1;min-width:220px"><i class="fas fa-magnifying-glass"></i><input type="text" placeholder="Rechercher un article..." oninput="filterM(this.value)"></div>
<button class="btn btn-ghost btn-sm" onclick="clearAll()"><i class="fas fa-trash-can"></i> Tout supprimer</button>
</div>
<div class="card" style="padding:0;overflow:hidden">
<div class="tc">
<table><thead><tr>
<th>R&#233;f. RS</th><th>D&#233;signation</th><th>Fabricant</th><th>Source</th>
<th style="text-align:center">Qt&#233;</th><th style="text-align:right">P.U. HT</th>
<th style="text-align:right">Total HT</th><th style="text-align:center;width:60px"></th>
</tr></thead><tbody id="tBody"></tbody></table>
</div>
<div id="emSt" class="es" style="padding:4rem 2rem">
<div class="es-icon"><i class="fas fa-box-open"></i></div>
<h3>Aucun mat&#233;riel</h3>
<p>Importez un CSV depuis RS Components ou ajoutez des articles manuellement</p>
</div>
</div>
<div class="sb" id="sumBox" style="display:none">
<div class="sr"><span class="lbl">Articles</span><span class="val" id="sArt">0</span></div>
<div class="sr"><span class="lbl">Total Mat&#233;riel HT</span><span class="val" id="sMat">0,00 &#8364;</span></div>
</div>
</div>

<!-- ========== DOCUMENT ========== -->
<div class="pnl" id="panel-document">
<div class="card np" id="docOptions">
<div class="ct" style="margin-bottom:1.25rem"><i class="fas fa-wand-magic-sparkles"></i> G&#233;n&#233;rer un document</div>
<div class="fr">
<div class="fg"><label>Type de document</label><select class="fc" id="pTy"><option value="devis">Devis simple (mat&#233;riel uniquement)</option><option value="devis-mo">Devis + Main d'&#339;uvre</option><option value="facture" selected>Facture compl&#232;te avec TVA</option></select></div>
<div class="fg"><label>Num&#233;ro</label><input type="text" class="fc" id="pNu" placeholder="G&#233;n&#233;r&#233; automatiquement"></div>
</div>
<div class="fr">
<div class="fg"><label>Date</label><input type="date" class="fc" id="pDa"></div>
<div class="fg"><label>Taux TVA</label><select class="fc" id="pTv"><option value="20" selected>20 % &#8212; taux normal</option><option value="10">10 % &#8212; taux interm&#233;diaire</option><option value="5.5">5,5 % &#8212; taux r&#233;duit</option><option value="0">0 % &#8212; exon&#233;r&#233;</option></select></div>
</div>
<div style="text-align:center;margin-top:1.5rem">
<button class="btn btn-pri btn-lg" onclick="genDoc()" style="min-width:260px"><i class="fas fa-bolt"></i> G&#233;n&#233;rer le document</button>
</div>
</div>
<div class="ab np" id="docActions" style="display:none">
<button class="btn btn-pri" onclick="window.print()"><i class="fas fa-print"></i> Imprimer / PDF</button>
<button class="btn btn-suc" onclick="expWord()"><i class="fas fa-file-word"></i> Export Word</button>
<div style="flex:1"></div>
<button class="btn btn-ghost" onclick="showDocOptions()"><i class="fas fa-arrow-left"></i> Nouveau document</button>
</div>
<div id="docC"></div>
</div>

</div>
</div>
</div>

<!-- MOBILE TOGGLE -->
<button class="mob-toggle" id="mobBtn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

<!-- Modal suppression -->
<div class="mov" id="mDel">
<div class="mod">
<h3><i class="fas fa-triangle-exclamation" style="color:var(--dan)"></i> Tout supprimer ?</h3>
<p>Cette action est irr&#233;versible. Tous les articles seront supprim&#233;s de la liste.</p>
<div class="moa"><button class="btn btn-ghost" onclick="closeMo('mDel')">Annuler</button><button class="btn btn-dan" onclick="doClear()">Supprimer tout</button></div>
</div>
</div>

<script>
// === 6 ENTREPRISES FICTIVES AVEC LOGOS SVG ===
var ENTREPRISES = [
  {
    id:'voltaelec', name:'VOLTA\u00c9LEC', slogan:'L\u2019\u00e9nergie ma\u00eetris\u00e9e',
    address:'12 rue Amp\u00e8re, 94000 Cr\u00e9teil', phone:'01 48 99 12 34', email:'contact@voltaelec.fr',
    siret:'412 345 678 00012', color:'#e63946',
    logo:'<svg viewBox="0 0 70 70"><circle cx="35" cy="35" r="32" fill="#e63946"/><path d="M38 12L22 40h12L28 58l20-30H36z" fill="#fff"/></svg>'
  },
  {
    id:'ohmservices', name:'OHM SERVICES', slogan:'Solutions \u00e9lectriques durables',
    address:'8 avenue Faraday, 77100 Meaux', phone:'01 60 25 67 89', email:'info@ohmservices.fr',
    siret:'523 456 789 00023', color:'#2a9d8f',
    logo:'<svg viewBox="0 0 70 70"><rect x="3" y="3" width="64" height="64" rx="12" fill="#2a9d8f"/><text x="35" y="44" font-family="Arial" font-size="28" font-weight="bold" fill="#fff" text-anchor="middle">\u2126</text></svg>'
  },
  {
    id:'wattplus', name:'WATT+', slogan:'Plus de puissance, plus de s\u00e9curit\u00e9',
    address:'25 bd Tesla, 93200 Saint-Denis', phone:'01 42 35 78 90', email:'devis@wattplus.fr',
    siret:'634 567 890 00034', color:'#e9c46a',
    logo:'<svg viewBox="0 0 70 70"><polygon points="35,3 67,35 35,67 3,35" fill="#e9c46a"/><text x="35" y="42" font-family="Arial" font-size="22" font-weight="bold" fill="#1d3557" text-anchor="middle">W+</text></svg>'
  },
  {
    id:'eclairpro', name:'\u00c9CLAIR PRO', slogan:'Votre \u00e9lectricien de confiance',
    address:'3 rue Volta, 91000 \u00c9vry', phone:'01 69 88 45 12', email:'contact@eclairpro.fr',
    siret:'745 678 901 00045', color:'#457b9d',
    logo:'<svg viewBox="0 0 70 70"><circle cx="35" cy="35" r="32" fill="#457b9d"/><circle cx="35" cy="35" r="18" fill="none" stroke="#fff" stroke-width="3"/><line x1="35" y1="17" x2="35" y2="25" stroke="#fff" stroke-width="3"/><line x1="35" y1="45" x2="35" y2="53" stroke="#fff" stroke-width="3"/><line x1="17" y1="35" x2="25" y2="35" stroke="#fff" stroke-width="3"/><line x1="45" y1="35" x2="53" y2="35" stroke="#fff" stroke-width="3"/><circle cx="35" cy="35" r="5" fill="#e9c46a"/></svg>'
  },
  {
    id:'ampereelec', name:'AMP\u00c8RE \u00c9LECTRIQUE', slogan:'Du courant \u00e0 la lumi\u00e8re',
    address:'17 rue Edison, 78000 Versailles', phone:'01 39 50 23 67', email:'pro@ampere-elec.fr',
    siret:'856 789 012 00056', color:'#6a4c93',
    logo:'<svg viewBox="0 0 70 70"><rect x="3" y="3" width="64" height="64" rx="16" fill="#6a4c93"/><text x="35" y="42" font-family="Arial" font-size="26" font-weight="bold" fill="#fff" text-anchor="middle">A</text><line x1="20" y1="52" x2="50" y2="52" stroke="#e9c46a" stroke-width="3"/></svg>'
  },
  {
    id:'courantech', name:'COURANTECH', slogan:'Innovation \u00e9lectrique',
    address:'42 rue Coulomb, 95100 Argenteuil', phone:'01 34 11 89 56', email:'hello@courantech.fr',
    siret:'967 890 123 00067', color:'#264653',
    logo:'<svg viewBox="0 0 70 70"><circle cx="35" cy="35" r="32" fill="#264653"/><path d="M20 35 Q25 20 35 20 Q45 20 50 35 Q45 50 35 50 Q25 50 20 35Z" fill="none" stroke="#2a9d8f" stroke-width="3"/><circle cx="35" cy="35" r="6" fill="#e76f51"/></svg>'
  }
];

var items=[], filt=null, docOk=false, selEnt=null;

var TAB_TITLES={
  params:'<i class="fas fa-sliders-h"></i> Param\u00e8tres du projet',
  import:'<i class="fas fa-file-import"></i> Import RS Components',
  materiel:'<i class="fas fa-boxes-stacked"></i> Liste de mat\u00e9riel',
  document:'<i class="fas fa-file-invoice-dollar"></i> Document'
};

function switchTab(n){
  document.querySelectorAll('.sb-item').forEach(function(t){t.classList.remove('active')});
  document.querySelectorAll('.pnl').forEach(function(p){p.classList.remove('active')});
  var item=document.querySelector('[data-tab="'+n+'"]');
  if(item) item.classList.add('active');
  document.getElementById('panel-'+n).classList.add('active');
  document.getElementById('topTitle').innerHTML=TAB_TITLES[n]||'';
  if(n==='materiel') renderT();
  // Close sidebar on mobile
  document.getElementById('sidebar').classList.remove('open');
}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
}

// === CSV PARSING (RS Components format) ===
function handleFile(e){
  var f=e.target.files[0]; if(!f) return;
  var r=new FileReader();
  r.onload=function(ev){ parseCSV(ev.target.result) };
  r.readAsText(f,'UTF-8');
}

function setupDZ(){
  var dz=document.getElementById('dropz');
  dz.addEventListener('dragover',function(e){e.preventDefault();dz.classList.add('over')});
  dz.addEventListener('dragleave',function(){dz.classList.remove('over')});
  dz.addEventListener('drop',function(e){
    e.preventDefault();dz.classList.remove('over');
    var f=e.dataTransfer.files[0];
    if(f){var r=new FileReader();r.onload=function(ev){parseCSV(ev.target.result)};r.readAsText(f,'UTF-8')}
  });
}

function parseCSV(text){
  var lines=text.split(/\r?\n/).filter(function(l){return l.trim()});
  if(lines.length<2){showIR('w','Fichier vide ou invalide.');return}
  var fl=lines[0];
  var d=fl.indexOf('\t')>=0?'\t':(fl.split(';').length>fl.split(',').length?';':',');
  var hdrs=pLine(fl,d).map(function(h){return h.trim().toLowerCase().replace(/^\ufeff/,'')});
  var cm=detCols(hdrs);
  var imp=0, skip=0;
  for(var i=1;i<lines.length;i++){
    var v=pLine(lines[i],d);
    if(v.length<2){skip++;continue}
    var ref=cm.ref>=0?(v[cm.ref]||'').trim().replace(/^"|"$/g,''):'';
    var nm=cm.name>=0?(v[cm.name]||'').trim().replace(/^"|"$/g,''):'';
    var pr=cm.price>=0?pPr(v[cm.price]):0;
    var qt=cm.qty>=0?(parseInt(v[cm.qty].replace(/"/g,''))||1):1;
    var mfr=cm.mfr>=0?(v[cm.mfr]||'').trim().replace(/^"|"$/g,''):'';
    if(!nm&&!ref){skip++;continue}
    items.push({id:gid(),ref:ref||'-',name:nm||'Article',price:pr,qty:qt,mfr:mfr,src:'rs'});
    imp++;
  }
  updB();
  showIR('s','<strong>'+imp+' article(s)</strong> import\u00e9(s) avec succ\u00e8s !'+(skip>0?' ('+skip+' ligne(s) ignor\u00e9e(s))':''));
}

function pLine(l,d){
  var r=[],c='',q=false;
  for(var i=0;i<l.length;i++){
    if(l[i]==='"') q=!q;
    else if(l[i]===d&&!q){r.push(c);c=''}
    else c+=l[i];
  }
  r.push(c);return r;
}

function detCols(h){
  var m={ref:-1,name:-1,price:-1,qty:-1,mfr:-1};
  h.forEach(function(x,i){
    var s=x.replace(/['"]/g,'').trim();
    if(m.ref<0&&(/stock\s*no|r[eé]f|ref|sku|num|part\b/i.test(s)))m.ref=i;
    if(m.name<0&&/description|d[eé]signation|nom|article|produit|libell/i.test(s))m.name=i;
    if(m.price<0&&/unit\s*price|prix\s*unit|tarif|p\.?u\.?\s*h\.?t|unit price/i.test(s))m.price=i;
    if(m.qty<0&&/quantit[eéy]|qty|qt[eé]|qte|nombre|nb/i.test(s))m.qty=i;
    if(m.mfr<0&&/manufacturer\s*name|fabricant|marque/i.test(s))m.mfr=i;
  });
  if(m.name<0) h.forEach(function(x,i){if(m.name<0&&/description/i.test(x))m.name=i});
  if(m.ref<0&&h.length>=1)m.ref=0;
  if(m.name<0&&h.length>=6)m.name=5;
  return m;
}

function pPr(v){if(!v)return 0;return parseFloat(v.replace(/["\u20ac$\u00a3\s]/g,'').replace(',','.').trim())||0}

function showIR(t,msg){
  var c=t==='s'?'al-s':'al-w',ic=t==='s'?'check-circle':'exclamation-triangle';
  document.getElementById('impRes').innerHTML='<div class="alert '+c+'"><i class="fas fa-'+ic+'"></i> '+msg+'</div>';
}

// === MANUAL ADD ===
function addManual(){
  var nm=document.getElementById('aName').value.trim();
  if(!nm){alert('Saisissez une d\u00e9signation.');return}
  items.push({id:gid(),ref:document.getElementById('aRef').value.trim()||'-',name:nm,
    price:parseFloat(document.getElementById('aPrice').value)||0,
    qty:parseInt(document.getElementById('aQty').value)||1,mfr:'-',src:'man'});
  document.getElementById('aRef').value='';document.getElementById('aName').value='';
  document.getElementById('aPrice').value='';document.getElementById('aQty').value='1';
  updB();showIR('s','<strong>'+esc(nm)+'</strong> ajout\u00e9 \u00e0 la liste.');
}

// === MATERIEL TABLE ===
function renderT(){
  var tb=document.getElementById('tBody'),em=document.getElementById('emSt'),su=document.getElementById('sumBox');
  var ds=filt!==null?filt:items;
  if(!items.length){tb.innerHTML='';em.style.display='block';su.style.display='none';return}
  em.style.display='none';su.style.display='block';
  tb.innerHTML=ds.map(function(it){
    return '<tr><td><span class="rb">'+esc(it.ref)+'</span></td><td>'+esc(it.name)+
    '</td><td>'+esc(it.mfr||'-')+'</td><td><span class="tag '+(it.src==='rs'?'tag-rs':'tag-m')+'">'+(it.src==='rs'?'RS':'Manuel')+
    '</span></td><td style="text-align:center"><input type="number" class="qi" value="'+it.qty+
    '" min="1" onchange="uQty(\''+it.id+'\',this.value)"></td><td style="text-align:right">'+
    fmt(it.price)+'</td><td style="text-align:right" class="price">'+fmt(it.price*it.qty)+
    '</td><td style="text-align:center"><button class="btn btn-dan btn-sm" onclick="remIt(\''+it.id+
    '\')"><i class="fas fa-times"></i></button></td></tr>';
  }).join('');
  document.getElementById('sArt').textContent=items.reduce(function(s,i){return s+i.qty},0);
  document.getElementById('sMat').textContent=fmt(items.reduce(function(s,i){return s+i.price*i.qty},0));
}
function uQty(id,v){var it=items.find(function(i){return i.id===id});if(it){it.qty=Math.max(1,parseInt(v)||1);renderT()}}
function remIt(id){items=items.filter(function(i){return i.id!==id});updB();renderT()}
function clearAll(){if(!items.length)return;document.getElementById('mDel').classList.add('active')}
function doClear(){items=[];updB();renderT();closeMo('mDel')}
function closeMo(id){document.getElementById(id).classList.remove('active')}
function filterM(q){filt=q?items.filter(function(i){return i.name.toLowerCase().indexOf(q.toLowerCase())>=0||i.ref.toLowerCase().indexOf(q.toLowerCase())>=0}):null;renderT()}

// === ENTREPRISE SELECTION ===
function renderEnts(){
  var g=document.getElementById('entGrid');
  g.innerHTML=ENTREPRISES.map(function(e){
    return '<div class="ent-card'+(selEnt&&selEnt.id===e.id?' sel':'')+'" onclick="pickEnt(\''+e.id+'\')" id="ec-'+e.id+'">'+
    '<div class="logo-svg">'+e.logo+'</div><h3>'+e.name+'</h3><p>'+e.slogan+'</p></div>';
  }).join('');
}
function pickEnt(id){
  selEnt=ENTREPRISES.find(function(e){return e.id===id});
  document.querySelectorAll('.ent-card').forEach(function(c){c.classList.remove('sel')});
  document.getElementById('ec-'+id).classList.add('sel');
  // Fill fields
  document.getElementById('pCo').value=selEnt.name;
  document.getElementById('pSi').value=selEnt.siret;
  document.getElementById('pAd').value=selEnt.address;
  document.getElementById('pPh').value=selEnt.phone;
  document.getElementById('pEm').value=selEnt.email;
}

// === DOCUMENT GENERATION ===
function genDoc(){
  if(!items.length){alert('Ajoutez du mat\u00e9riel d\'abord.');return}
  var dt=document.getElementById('pTy').value;
  var tr=parseFloat(document.getElementById('pTv').value)/100;
  var co=document.getElementById('pCo').value||'Mon Entreprise';
  var si=document.getElementById('pSi').value;
  var ad=document.getElementById('pAd').value;
  var ph=document.getElementById('pPh').value;
  var em=document.getElementById('pEm').value;
  var cn=document.getElementById('cNm').value||'Client';
  var cc=document.getElementById('cCo').value;
  var ca=document.getElementById('cAd').value;
  var ccp=document.getElementById('cCp').value;
  var cvi=document.getElementById('cVi').value;
  var fullAddr=ca;
  if(ccp||cvi) fullAddr+=(ca?', ':'')+ccp+' '+cvi;
  var dd=document.getElementById('pDa').value||new Date().toISOString().split('T')[0];
  var dn=document.getElementById('pNu').value;
  var hr=parseFloat(document.getElementById('pHr').value)||0;
  var hs=parseFloat(document.getElementById('pHs').value)||0;
  var wd=document.getElementById('pWd').value;
  var rty=document.getElementById('rTy').value;
  var rva=parseFloat(document.getElementById('rVa').value)||0;

  if(!dn){dn=(dt==='facture'?'FA':'DV')+'-'+new Date().getFullYear()+'-'+String(Math.floor(Math.random()*9999)).padStart(4,'0');document.getElementById('pNu').value=dn}

  var tl=dt==='facture'?'FACTURE':'DEVIS';
  var tm=items.reduce(function(s,i){return s+i.price*i.qty},0);
  var tmo=dt!=='devis'?hr*hs:0;
  var sub=tm+tmo;
  var disc=rty==='percent'?sub*(rva/100):rty==='fixed'?rva:0;
  var tht=sub-disc;
  var tva=dt==='facture'?tht*tr:0;
  var ttc=tht+tva;
  var fd=function(d){var p=d.split('-');return p[2]+'/'+p[1]+'/'+p[0]};

  // Logo
  var logoHtml='';
  if(selEnt) logoHtml='<div class="logo-svg">'+selEnt.logo+'</div>';

  var rows=items.map(function(it,idx){
    return '<tr><td style="text-align:center">'+(idx+1)+'</td><td><span style="font-family:monospace;font-size:.8rem;color:#666">'+
    esc(it.ref)+'</span></td><td>'+esc(it.name)+'</td><td style="text-align:center">'+it.qty+
    '</td><td style="text-align:right">'+fmt(it.price)+'</td><td style="text-align:right;font-weight:600">'+fmt(it.price*it.qty)+'</td></tr>';
  }).join('');

  if(dt!=='devis'&&tmo>0){
    rows+='<tr style="background:#f0f9ff"><td style="text-align:center">'+(items.length+1)+
    '</td><td>-</td><td><strong>Main d\u2019\u0153uvre</strong> - '+esc(wd)+
    '</td><td style="text-align:center">'+hs+'h</td><td style="text-align:right">'+fmt(hr)+
    '/h</td><td style="text-align:right;font-weight:600">'+fmt(tmo)+'</td></tr>';
  }

  var h='<div class="dp" id="docP"><div class="dh"><div class="dco">'+logoHtml+'<div class="info"><h2>'+esc(co)+'</h2>'+
    (ad?'<p>'+esc(ad)+'</p>':'')+(ph?'<p>T\u00e9l: '+esc(ph)+'</p>':'')+
    (em?'<p>'+esc(em)+'</p>':'')+(si?'<p style="font-size:.78rem;margin-top:.2rem">SIRET: '+esc(si)+'</p>':'')+
    '</div></div><div class="dty"><h3>'+tl+'</h3><div class="dn">N\u00b0 '+esc(dn)+'</div><div class="dd">Date: '+fd(dd)+'</div>'+
    (dt!=='facture'?'<div class="dd">Validit\u00e9: 30 jours</div>':'')+'</div></div>';

  h+='<div class="dcb"><h4>Client</h4><strong>'+esc(cn)+'</strong>'+(cc?'<br>'+esc(cc):'')+(fullAddr?'<br>'+esc(fullAddr):'')+'</div>';
  if(dt!=='devis'&&wd) h+='<p style="margin-bottom:1rem;font-style:italic;color:#555">Objet : '+esc(wd)+'</p>';

  h+='<table class="dtb"><thead><tr><th style="text-align:center;width:40px">N\u00b0</th><th style="width:80px">R\u00e9f.</th><th>D\u00e9signation</th><th style="text-align:center;width:50px">Qt\u00e9</th><th style="text-align:right;width:85px">P.U. HT</th><th style="text-align:right;width:95px">Total HT</th></tr></thead><tbody>'+rows+'</tbody></table>';

  h+='<div class="tots">';
  h+='<div class="rw"><span>Total Mat\u00e9riel HT</span><span>'+fmt(tm)+'</span></div>';
  if(tmo>0) h+='<div class="rw"><span>Main d\u2019\u0153uvre HT</span><span>'+fmt(tmo)+'</span></div>';
  if(disc>0) h+='<div class="rw"><span>Remise'+(rty==='percent'?' ('+rva+'%)':'')+'</span><span>- '+fmt(disc)+'</span></div>';
  h+='<div class="rw" style="font-weight:600"><span>Total HT</span><span>'+fmt(tht)+'</span></div>';
  if(dt==='facture') h+='<div class="rw"><span>TVA ('+(tr*100).toFixed(1)+'%)</span><span>'+fmt(tva)+'</span></div>';
  h+='<div class="rw grand"><span>Total '+(dt==='facture'?'TTC':'HT')+'</span><span>'+fmt(dt==='facture'?ttc:tht)+'</span></div></div>';

  if(dt==='facture') h+='<div style="margin-top:1.5rem;padding:.8rem;background:#f9fafb;border-radius:8px;font-size:.8rem;color:#666"><strong>Conditions de paiement :</strong> Paiement \u00e0 30 jours \u00e0 r\u00e9ception de facture.<br><strong>P\u00e9nalit\u00e9s de retard :</strong> 3 fois le taux d\u2019int\u00e9r\u00eat l\u00e9gal. Indemnit\u00e9 forfaitaire de recouvrement : 40 \u20ac.</div>';
  if(dt.indexOf('devis')>=0) h+='<div style="margin-top:1.5rem;padding:.8rem;background:#f9fafb;border-radius:8px;font-size:.8rem;color:#666"><strong>Bon pour accord :</strong><br><br>Date : ________________\u00a0\u00a0\u00a0\u00a0Signature : ________________</div>';

  h+='<div class="df">'+esc(co)+(si?' \u2022 SIRET: '+esc(si):'')+'<br>Document g\u00e9n\u00e9r\u00e9 avec MELEC - Devis &amp; Facturation</div></div>';

  document.getElementById('docC').innerHTML=h;
  docOk=true;
  document.getElementById('docOptions').style.display='none';
  document.getElementById('docActions').style.display='flex';
  // Ensure we're on document tab
  if(!document.getElementById('panel-document').classList.contains('active')){
    switchTab('document');
  }
}

// === EXPORTS ===
function svgToDataUrl(svgStr){
  return 'data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(svgStr)));
}

function expWord(){
  var c=document.getElementById('docP');
  if(!c){alert('G\u00e9n\u00e9rez le document d\'abord.');return}
  // Clone and convert SVG logos to img tags for Word compatibility
  var clone=c.cloneNode(true);
  var svgs=clone.querySelectorAll('svg');
  svgs.forEach(function(svg){
    var svgStr=new XMLSerializer().serializeToString(svg);
    var img=document.createElement('img');
    img.src=svgToDataUrl(svgStr);
    img.style.width=svg.getAttribute('width')?svg.getAttribute('width')+'px':'60px';
    img.style.height=svg.getAttribute('height')?svg.getAttribute('height')+'px':'60px';
    if(svg.closest('.logo-svg')){img.style.width='60px';img.style.height='60px'}
    svg.parentNode.replaceChild(img,svg);
  });
  var h='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><style>body{font-family:Calibri,sans-serif;font-size:11pt}table{border-collapse:collapse;width:100%}th{background:#1a56db;color:#fff;padding:6px 8px;font-size:9pt;text-align:left}td{padding:5px 8px;border-bottom:1px solid #ddd;font-size:10pt}h2{color:#1a56db;margin:0}h3{color:#1e40af;margin:0}p{margin:2px 0}.dh{display:flex;border-bottom:3px solid #1a56db;padding-bottom:12px;margin-bottom:15px}.dco{display:flex;align-items:center;gap:10px}.tots .rw{display:flex;justify-content:space-between;padding:3px 0}.tots .rw.grand{border-top:2px solid #1f2937;font-weight:bold;font-size:13pt;padding-top:6px;margin-top:4px}.dcb{background:#f5f5f5;padding:8px;border-radius:4px;margin-bottom:12px}.df{margin-top:15px;padding-top:8px;border-top:1px solid #ddd;font-size:8pt;color:#999;text-align:center}</style></head><body>'+clone.innerHTML+'</body></html>';
  dlB(new Blob(['\ufeff',h],{type:'application/msword'}),gfn('.doc'));
}

function showDocOptions(){
  document.getElementById('docOptions').style.display='block';
  document.getElementById('docActions').style.display='none';
  document.getElementById('docC').innerHTML='';
  document.getElementById('pNu').value='';
  docOk=false;
}

function toggleMoFields(){
  var dt=document.getElementById('pTy').value;
  var moCard=document.querySelector('#panel-params .card:nth-last-child(2)');
  // MO fields visibility hint - no hide needed since they're in params
}

// === UTILS ===
function gid(){return 'i'+Math.random().toString(36).substr(2,9)}
function fmt(v){return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(v)}
function esc(s){if(!s)return '';var d=document.createElement('div');d.textContent=s;return d.innerHTML}
function updB(){document.getElementById('bc').textContent=items.length}
function gfn(e){var t=document.getElementById('pTy').value;var n=document.getElementById('pNu').value||'doc';return(t==='facture'?'Facture':'Devis')+'_'+n+e}
function dlB(b,n){var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click();URL.revokeObjectURL(a.href)}

function resetAll(){
  if(items.length>0&&!confirm('R\u00e9initialiser ? Toutes les donn\u00e9es seront perdues.'))return;
  items=[];filt=null;docOk=false;updB();
  document.getElementById('docC').innerHTML='';
  document.getElementById('docOptions').style.display='block';
  document.getElementById('docActions').style.display='none';
  document.getElementById('pNu').value='';
  document.getElementById('impRes').innerHTML='';
  switchTab('params');
}

// === CODE POSTAL -> VILLE (API geo.api.gouv.fr) ===
var cpTimeout=null;
function lookupCP(val){
  var st=document.getElementById('cpStatus');
  var vi=document.getElementById('cVi');
  val=val.replace(/\D/g,'');
  document.getElementById('cCp').value=val;
  if(val.length<5){vi.value='';st.innerHTML='';vi.readOnly=true;vi.style.background='var(--g50)';return}
  if(val.length===5){
    st.innerHTML='<i class="fas fa-spinner fa-spin"></i> Recherche...';
    if(cpTimeout) clearTimeout(cpTimeout);
    cpTimeout=setTimeout(function(){
      fetch('https://geo.api.gouv.fr/communes?codePostal='+val+'&fields=nom&limit=10')
      .then(function(r){return r.json()})
      .then(function(data){
        if(data.length===0){
          st.innerHTML='<span style="color:var(--dan)"><i class="fas fa-times-circle"></i> Code postal non trouv\u00e9</span>';
          vi.value='';vi.readOnly=true;vi.style.background='var(--g50)';
        } else if(data.length===1){
          vi.value=data[0].nom;
          vi.readOnly=true;vi.style.background='var(--g50)';
          st.innerHTML='<span style="color:var(--suc)"><i class="fas fa-check-circle"></i> '+data[0].nom+'</span>';
        } else {
          // Multiple cities for this CP - show select
          vi.readOnly=false;vi.style.background='#fff';
          vi.value=data[0].nom;
          var opts=data.map(function(c){return c.nom}).join(', ');
          st.innerHTML='<span style="color:var(--pri)"><i class="fas fa-info-circle"></i> Plusieurs villes : '+opts+'</span>';
        }
      })
      .catch(function(){
        st.innerHTML='<span style="color:var(--dan)"><i class="fas fa-wifi-slash"></i> Hors ligne - saisissez la ville manuellement</span>';
        vi.readOnly=false;vi.style.background='#fff';
      });
    },300);
  }
}

// INIT
document.addEventListener('DOMContentLoaded',function(){
  document.getElementById('pDa').value=new Date().toISOString().split('T')[0];
  setupDZ();
  renderEnts();
});

</script>
</body>
</html>
